{% doc %}
  Renders a slide-in filters drawer for collection pages with facets and optional sorting. 
  Uses Alpine.js for open/close state and persists the last opened facet between visits.

  @param {collection} results - The collection object providing filters/sort options
  @param {boolean} enable_filtering - Show filter facets
  @param {boolean} enable_sorting - Show sorting select inside the drawer
  @param {string} color_scheme - Color scheme for the drawer (optional, defaults to 'scheme-1')
  @param {string} section_id - Unique identifier for the section (required for proper DOM IDs)
  @param {string} show_filter_count - Show filter count
  @param {string} context - Context of the drawer (collection or search)

  @example
  {% render 'component-filters-drawer', results: collection, enable_sorting: true, enable_filtering: true, color_scheme: 'scheme-1', section_id: section.id %}
{% enddoc %}

{%- style -%}
  .filters-drawer {
    width: calc(100% - 50px);
    max-width: 370px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 100;
    background: white;
    transition: transform 0.3s ease;
  }

  .drawer-main-wrapper:not(.drawer-active) .drawer-overlay {
    opacity: 0;
    transition: opacity 0.4s, width 0s linear 0.4s, visibility 0s linear 0.4s;
    visibility: hidden;
    width: 0;
    pointer-events: none;
  }

  .drawer-main-wrapper:not(.drawer-active) .drawer__wrapper {
    transform: translate(-100%, 0px);
  }

  .drawer__facet-button-trigger {
    border: none;
    background: none;
    display: flex;
    align-items: center;
    padding: 0px;
    margin: 0px;
    cursor: pointer;
  }

  .drawer__facet-button-trigger span {
    margin-left: 10px;
    font-size: 1.6rem;
    color: rgba(var(--color-foreground), 0.75);
  }

  .drawer__facet-button-trigger:hover span {
    text-decoration: underline;
  }

  .facets__header-drawer {
    position: relative;
    flex-shrink: 0;
  }

  .child-facets__header-wrapper {
    border-bottom: 1px solid rgba(var(--color-foreground), 0.08);
    padding: 15px 25px;
    display: flex;
    justify-content: flex-start;
    position: relative;
    z-index: 2;
    background: white;
  }

  .mobile-facets__heading {
    margin: 0px;
    margin-bottom: 5px;
    font-size: 16px;
  }

  .drawer__count-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 23px;
  }

  .drawer__count-wrapper .loading-overlay__spinner {
    width: 15px;
    height: 15px;
  }

  .mobile-facets__count {
    color: rgba(var(--color-foreground), 0.7);
    font-size: 14px;
    margin: 0;
  }

  .drawer-close-icon {
    display: flex;
    align-items: center;
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translate(0%, -50%);
    cursor: pointer;
  }

  .drawer-close-icon .svg-wrapper {
    width: 25px;
    height: 25px;
    position: relative;
    right: -2px;
  }

  .filters__drawer-form {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
  }

  .drawer__child-facets-wrapper,
  .drawer__child-sorting-wrapper {
    padding: 30px 25px 15px 25px;
  }

  .drawer__child-sorting-wrapper {
    padding-top: 15px;
    flex-shrink: 0;
  }

  .mobile-facets__block {
    font-size: 16px;
    letter-spacing: 0.6px;
    font-weight: 500;
    padding: 17px 0px 12px 0px;
    border-top: 1px solid rgba(var(--color-foreground), 0.1);
  }

  .single-facet__link:first-child .mobile-facets__block {
    border-top: none;
  }

  .drawer__facets-wrapper {
    width: 100%;
    flex: 1;
    position: relative;
    overflow-x: hidden;
    overflow-y: auto;
    min-height: 0;
    padding-bottom: 65px;
  }

  .filters-drawer__buttons-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    bottom: 15px;
    left: 0;
    gap: 10px;
    right: 0;
    width: 100%;
    padding: 0px 20px;
    z-index: 111;
  }

  .filters-drawer__buttons-wrapper .clear-all-button {
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    border: none;
    background: #fafafa;
    text-decoration: underline;
    text-decoration-color: transparent;
    text-decoration-thickness: .075em;
    text-underline-offset: .125em;
    transition: text-decoration-color 0.3s ease;
    border: 1px solid black;
    transition: background 0.3s ease;
    width: calc(50% - 5px);
  }
  

  .filters-drawer__buttons-wrapper .clear-all-button:hover {
    background: #fafafa;
    transition: background 0.3s ease, text-decoration-color 0.3s ease;
  }

  .filters-drawer__buttons-wrapper .see-items-button {
    background: black;
    color: white;
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    border: none;
    width: 100%;
    transition: opacity 0.3s ease;
  }

  .filters-drawer__buttons-wrapper .see-items-button:hover {
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  .filters-drawer__buttons-wrapper:has(.clear-all-button) .see-items-button {
    width: calc(50% - 5px);
  }

  #active-filters-count-{{ section_id }} {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  #active-filters-count-{{ section_id }} span {
    font-size: 1.3rem;
    font-weight: 500;
    background: rgb(0,0,0, 0.1);
    border-radius: 20px;
    padding: 3px 6px;
  }

  .facets__values-drawer {
    padding-bottom: 10px;
  }

  .filter__values-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0px;
  }

  .filter__values-wrapper .facet-checkbox {
    padding: 14px 0px;
    font-size: 15px;
  }

  .filter__values-wrapper .facet-checkbox .icon-filter-rounded {
    height: 15px;
    width: 15px;
    border-radius: 5px;
    border: 1px solid rgba(var(--color-foreground), 0.5);
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .filter__values-wrapper .facet-checkbox .icon-filter-rounded svg {
    width: 10px;
    height: 10px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .filter__values-wrapper .facet-checkbox input:checked ~ .icon-filter-rounded svg {
    opacity: 1;
  }

  .filters__show-more {
    background: white;
    border: none;
    padding: 10px 0px;
    cursor: pointer;
    margin-top: 10px;
    outline: 1px solid transparent;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
  }

  .filters__show-more span.icon-plus svg,
  .filters__show-more span.icon-minus svg {
    width: 15px;
    height: 15px;
  }

  .mobile-facets__footer {
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
    padding: 20px;
    bottom: 0;
    position: sticky;
    display: flex;
    z-index: 9;
    margin-top: auto;
    background-color: rgb(var(--color-background));
    background: white;
  }

  .mobile-facets__clear-wrapper {
    align-items: center;
    display: flex;
    justify-content: center;
  }

  .mobile-facets__footer > * {
    width: 50%;
  }

  .mobile-facets__footer button {
    border: none;
    background: black;
    color: white;
    padding: 15px;
    font-size: 16px;
    cursor: pointer;
  }

  .mobile-facets__clear-wrapper a {
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .drawer__child-sorting-wrapper .facet-filters__field {
    justify-content: space-between;
    margin-right: 0px;
  }

  body:has(.drawer-main-wrapper.drawer-active) {
    overflow: hidden;
  }

  @media screen and (max-width: 768px) {
    .drawer-main-wrapper .mobile-facets__heading {
      font-size: 2.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .drawer-main-wrapper .mobile-facets__count {
      font-size: 13px;
    }
    .drawer-main-wrapper .mobile-facets__block span {
      font-size: 15px;
    }
    .drawer-main-wrapper .facet-filters__sort {
      font-size: 12px;
    }
    .drawer-main-wrapper .filter__values-wrapper .facet-checkbox {
      font-size: 14px;
      padding: 12px 0px;
    }
    .drawer-main-wrapper .mobile-facets__block {
      font-size: 15px;
    }
  }
{%- endstyle -%}

{% liquid
  assign show_more_number = 10
  assign active_filters_count = 0

  for f in results.filters
    unless f.param_name == 'sort_by'
      if f.type == 'price_range'
        if f.min_value.value > 0 or f.max_value.value < f.range_max
          assign active_filters_count = active_filters_count | plus: 1
        endif
      else
        assign active_filters_count = active_filters_count | plus: f.active_values.size
      endif
    endunless
  endfor
%}
<div
  x-data="{ open: false }"
  class="drawer-main-wrapper color-{{ color_scheme | default: 'scheme-1' }} {% unless enable_filtering %}large-up-hide{% endunless %}"
  :class="{ 'drawer-active': open }"
  id="Details-{{ section_id }}"
>
  <button type="button" @click="open = !open" class="drawer__facet-button-trigger">
    <div class="svg-wrapper">
      {{ 'icon-filter.svg' | inline_asset_content }}
    </div>
    <div class="desktop-facet-text-wrapper small-hide">
      {%- if enable_filtering -%}
        <span>{{ 'products.facets.filter_button' | t }}</span>
      {%- elsif enable_sorting -%}
        <span>{{ 'products.facets.sort_button' | t }}</span>
      {%- endif -%}
    </div>
    <div class="mobile-facet-text-wrapper large-up-hide">
      {%- if enable_filtering and enable_sorting -%}
        <span>{{ 'products.facets.filter_and_sort' | t }}</span>
      {%- elsif enable_filtering -%}
        <span>{{ 'products.facets.filter_button' | t }}</span>
      {%- elsif enable_sorting -%}
        <span>{{ 'products.facets.sort_button' | t }}</span>
      {%- endif -%}
    </div>
  </button>

  <div class="drawer-overlay" @click="open = !open">
    <span hidden>{{ 'accessibility.close' | t }}</span>
  </div>

  <div class="drawer__wrapper filters-drawer">
    <div class="facets__header-drawer">
      <div class="child-facets__header-wrapper">
        <div class="mobile-facets__header-inner">
          <h2 class="mobile-facets__heading large-up-hide">
            {%- if enable_filtering and enable_sorting -%}
              {{ 'products.facets.filter_and_sort' | t }}
            {%- elsif enable_filtering -%}
              {{ 'products.facets.filter_button' | t }}
            {%- elsif enable_sorting -%}
              {{ 'products.facets.sort_button' | t }}
            {%- endif -%}
            <span id="active-filters-count-{{ section_id }}">
              {% if active_filters_count > 0 %}
                <span>{{ active_filters_count }}</span>
              {% endif %}
            </span>
          </h2>
          <h2 class="mobile-facets__heading small-hide">
            {%- if enable_filtering -%}
              {{ 'products.facets.filter_button' | t }}
            {%- elsif enable_sorting -%}
              {{ 'products.facets.sort_button' | t }}
            {%- endif -%}
          </h2>
          <div class="drawer__count-wrapper hidden">
            <p class="mobile-facets__count" id="drawer-results-count-{{ section_id }}">
              {% if context == 'collection' %}
                {%- if results.products_count == results.all_products_count -%}
                  {{ 'products.facets.results_count' | t: count: results.products_count }}
                {% else %}
                  {{ 'products.facets.results_count_of' | t: count: results.products_count, total: results.all_products_count }}
                {% endif %}
              {% else %}
                {{ 'templates.search.results_with_count' | t: terms: results.terms, count: results.results_count }}
              {% endif %}
            </p>
            <div id="drawer-loading-spinner-{{ section_id }}" class="loading-overlay__spinner"></div>
          </div>
        </div>
        <div class="drawer-close-icon" @click="open = !open">
          <div class="svg-wrapper">
            {{ 'icon-close.svg' | inline_asset_content }}
          </div>
        </div>
      </div>
    </div>
    <form id="filters-form-drawer" class="filters__drawer-form">
      <div class="drawer__facets-wrapper">
        <div class="drawer__child-facets-wrapper">
          {%- for f in results.filters -%}
            <div
              id="Details-{{ f.param_name | escape }}-{{ section_id }}-Drawer"
              class="single-facet__link js-filter"
            >
              <div class="mobile-facets__block">
                <span>{{ f.label }}</span>
              </div>
              <div
                class="facets__values-drawer"
                x-data="{ showMore : $persist(false).as('sm-drawer-{{ f.param_name }}') }"
              >
                <div class="filter__values-wrapper">
                  {% if f.type == 'price_range' %}
                    {% render 'component-filters-price-range', filter: f, id_prefix: 'Filter-Drawer-' %}
                  {% else %}
                    {%- for v in f.values -%}
                      {%- assign input_id = 'Filter-Drawer-' | append: f.param_name | escape | append: '-' | append: forloop.index -%}
                      <label
                        class="facet-checkbox"
                        {% if forloop.index > show_more_number %}
                          x-show="showMore"
                          x-transition
                        {% endif %}
                      >
                        <input
                          id="{{ input_id }}"
                          type="checkbox"
                          name="{{ v.param_name }}"
                          value="{{ v.value }}"
                          data-render-section="filters-form-drawer"
                          data-track-content-type="filter"
                          data-track-item-id="{{ f.param_name | escape }}_{{ v.value | handleize }}"
                          data-track-item-name="{{ f.label | escape }}: {{ v.label | escape }}"
                          {% if v.active %}
                            checked
                          {% endif -%}
                          {% if v.count == 0 and v.active == false %}
                            disabled
                          {% endif -%}
                        >
                        <span class="icon-filter-rounded">
                          {{- 'icon-checkmark.svg' | inline_asset_content -}}
                        </span>
                        <span class="filter-label">
                          {{- v.label }}
                          {% if show_filter_count != blank %} ({{ v.count }}){% endif %}
                        </span>
                      </label>
                    {%- endfor -%}
                  {% endif %}
                  {%- if f.type != 'price_range' and f.values.size > show_more_number -%}
                    <button
                      type="button"
                      class="filters__show-more"
                      x-on:click="showMore = !showMore"
                    >
                      <span class="icon-plus" x-show="!showMore">{{ 'icon-plus.svg' | inline_asset_content }}</span>
                      <span class="icon-minus" x-show="showMore">{{ 'icon-minus.svg' | inline_asset_content }}</span>
                      <span x-text="showMore ? 'Show less' : 'Show more'">Show more</span>
                    </button>
                  {%- endif %}
                </div>
              </div>
            </div>
          {%- endfor -%}
        </div>
        {%- if enable_sorting -%}
          <div class="drawer__child-sorting-wrapper">
            {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
            <div id="sort-by-drawer-{{ section_id }}" class="facet-filters__field large-up-hide">
              <h2 class="facet-filters__label">
                <label for="SortBy">{{ 'products.facets.sort_by_label' | t }}</label>
              </h2>
              <select
                data-render-section="filters-form-drawer"
                name="sort_by"
                id="SortBy"
                class="facet-filters__sort"
                data-track-content-type="sort"
              >
                {%- for option in results.sort_options -%}
                  <option
                    value="{{ option.value | escape }}"
                    data-track-item-id="{{ option.value | handleize }}"
                    data-track-item-name="{{ option.name | escape }}"
                    {% if option.value == sort_by %}
                      selected="selected"
                    {% endif %}
                  >
                    {{ option.name | escape }}
                  </option>
                {%- endfor -%}
              </select>
            </div>
          </div>
        {%- endif -%}

        {%- liquid
          assign clear_filters_url = ''
          if context == 'collection'
            assign sort_by = results.sort_by | default: results.default_sort_by
            assign clear_filters_url = results.url | append: '?sort_by=' | append: sort_by
          elsif context == 'search'
            assign terms = results.terms | escape
            assign clear_filters_url = '?q=' | append: terms
          else
            assign sort_by = results.sort_by | default: results.default_sort_by
            assign clear_filters_url = results.url | append: '?sort_by=' | append: sort_by
          endif
        -%}

        <div id="filters-drawer-buttons-wrapper-id" class="filters-drawer__buttons-wrapper">
          {% if active_filters_count > 0 %}
            <button 
              type="button" 
              id="clear-all-button-{{ section_id }}" 
              class="clear-all-button" 
              data-render-section-url="{{ clear_filters_url }}"
              @click="open = !open"
            >
              Clear all
            </button>
          {% endif %}

          <button type="button" id="see-items-button-{{ section_id }}" class="see-items-button" @click="open = !open">
            {% if context == 'collection' %}
              See {{ results.products_count }} items
            {% else %}
              See {{ results.results_count }} items
            {% endif %}
          </button>
        </div>

      </div>
    </form>
  </div>
</div>
